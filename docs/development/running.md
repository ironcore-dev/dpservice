# Running the Dataplane Service

## Prerequisities

### Smart NIC
To operate properly, dp-service needs a SmartNIC (currently only Mellanox is supported) with SR-IOV and at least one VF enabled in firmware.

You can run the service in [testing](../testing/) mode without such a card using virtual interfaces.

### Kernel
Any recent stable kernel should be enough. Most distributions should not require you to change anything the kernel itself. But for completeness (and for those using custom kernels), see [this guide](kernel.md).

### Huge pages
DPDK (and dp-service) leverage the use of hugepages provided by the CPU. If possible, 1GB pages are used, but 2MB pages are also supported.

First, you need to enable 1GB hugepages via kernel command-line options:
```bash
sudo sed -i -r 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="default_hugepagesz=1G hugepagesz=1G hugepages=4 /' /etc/default/grub
sudo update-grub
```
> The `hugepages=4` can also be done later via `sysctl vm.nr_hugepages=4` or `echo 4 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages`.

Second, you need to mount the hugepage filesystem, either manually or via `/etc/fstab`:
```bash
hugetlbfs    /dev/hugepages    hugetlbfs    x-mount.mkdir=0770,mode=0770,gid=1000,pagesize=1G,size=4G
```
(Notice that this also enables full access to a group with `gid=1000`. This can be useful for [running the service as a user](#usermode-dp-service).)

If absolutely necessary, to use 2MB pages instead of 1GB, the kernel command-line step can be ignored, as the OS should default to 2MB pages. Just change all numerical values to give the right amount of memory (i.e. 2048 pages of 2048kB each).


## Usermode dp-service
If running as user, hugepages may require many memory locks (depends on your memory configuration). In that case you may want to raise the `memlock` limit for the user. DPDK also documents `nofile` and `locks` limits as possible choke-points. The usual way to change limits is via `/etc/security/limits.conf`.

For VMs to be able to connect to virtual functions, you need to make them accessible, e.g. `sudo chmod a+rw /dev/vfio/18` or even better via creating a special group and adding your user into it.


## Command-line arguments
Unless run via `dpservice-user`, all `dpservice-bin` commands need to be run as root.

For details about command-line arguments [see here](../deployment/commandline.md) or use `dpservice-bin --help` for EAL options and `dpservice-bin -- --help` for the actual service options.

Currently, dp-service only supports Mellanoc NICs and virtual interfaces for testing. Thus most arguments are not needed and are being provided another way.

### Mellanox cards
To prepare Mellanox cards to work with `dpservice-bin` a `prepare.sh` script in `hack/` is provided. It should create appropriate number of virtual interfaces and put them into *switchdev mode*. For more information and/or troubleshooting, please see [Mellanox specific documentation](mellanox.md)

In order to have this preparation happen automatically on every boot, you can use the `hack/preparedp.service` systemd unit.
```bash
cp hack/prepare.sh /usr/local/sbin/dp-prepare.sh
chmod +x /usr/local/sbin/dp-prepare.sh
cp hack/preparedp.service /etc/systemd/system/preparedp.service
systemctl daemon-reload
systemctl enable preparedp.service
```

Then you can simply run `dpservice-bin -l0,1 -- --no-stats --no-offload` for the most basic setup. See help output for more info.

### Virtual interfaces
For automated testing and some working setups, virtual interfaces are used and thus no more setup is needed. The whole command-line is generated by [test-scripts](../testing/).

If you want to run the service using the same arguments as the automated tests are using, run it via `tests/dp_service.py` helper script (no arguments are needed, but see `--help` for more information). You can even run it under debugger (`dp_service.py --gdb`) and run test against that using `pytest --attach` (see [testing](../testing/) section for more).

### Manual invocation
Without the help of scripts or config files, you can run the service directly (adjust the interface names according to your machine):
```bash
./dpservice-bin -a 0000:3b:00.0,representor=0-5 -a 0000:3b:00.1 -l 0,1 -- --pf0=enp59s0f1 --pf1=enp59s0f1 --vf-pattern=enp59s0f0_ --ipv6=2a10:afc0:e01f:209:: --no-stats --no-offload
```

`-a` arguments set the PCI addresses of the smartnic's ports along with the VF range specification (6 VFs in this example).

`--pf0` and `--pf1` set the interface names of the uplink ports of the hypervisor's (your machine's) smartnic.

`--vf_pattern` defines the prefix used by the virtual functions created by the smartnic and which need to be controlled by dp-service. These interfaces are then to be used by running VMs.

`--ipv6` sets the underlay IPv6 address which should be used by dp-service for ingress/egress packets coming to/leaving the smartnic.
